{% extends 'base.html' %}

{% block title %}„ÉÅ„É£„ÉÉ„Éà - ÂøÉÁêÜ„Ç´„Ç¶„É≥„Çª„É™„É≥„Ç∞AI„Äå„Éü„É©„Ç§„Äç{% endblock %}

{% block extra_css %}
<style>
    .chat-container {
        height: 70vh;
        display: flex;
        flex-direction: column;
    }
    
    .messages-container {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background-color: #f8f9fa;
        border-radius: 10px;
        margin-bottom: 20px;
    }
    
    .message {
        margin-bottom: 15px;
        display: flex;
        align-items: flex-start;
    }
    
    .message.user {
        justify-content: flex-end;
    }
    
    .message.assistant {
        justify-content: flex-start;
    }
    
    .message-content {
        max-width: 70%;
        padding: 12px 16px;
        border-radius: 18px;
        line-height: 1.4;
        position: relative;
    }
    
    .message.user .message-content {
        background-color: #007bff;
        color: white;
        border-bottom-right-radius: 4px;
    }
    
    .message.assistant .message-content {
        background-color: white;
        color: #333;
        border: 1px solid #dee2e6;
        border-bottom-left-radius: 4px;
    }
    
    .message-input-container {
        display: flex;
        gap: 10px;
        align-items: center;
        padding: 15px;
        background-color: white;
        border-radius: 10px;
        border: 1px solid #dee2e6;
    }
    
    .message-input {
        flex: 1;
        border: none;
        outline: none;
        padding: 10px;
        border-radius: 20px;
        background-color: #f8f9fa;
        resize: none;
        min-height: 40px;
        max-height: 120px;
    }
    
    .send-button {
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    
    .send-button:hover {
        background-color: #0056b3;
    }
    
    .send-button:disabled {
        background-color: #6c757d;
        cursor: not-allowed;
    }
    
    .typing-indicator {
        display: none;
        padding: 12px 16px;
        background-color: white;
        border: 1px solid #dee2e6;
        border-radius: 18px;
        border-bottom-left-radius: 4px;
        max-width: 70%;
    }
    
    .typing-dots {
        display: flex;
        gap: 4px;
    }
    
    .typing-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background-color: #6c757d;
        animation: typing 1.4s infinite;
    }
    
    .typing-dot:nth-child(2) {
        animation-delay: 0.2s;
    }
    
    .typing-dot:nth-child(3) {
        animation-delay: 0.4s;
    }
    
    @keyframes typing {
        0%, 60%, 100% {
            transform: translateY(0);
        }
        30% {
            transform: translateY(-10px);
        }
    }
    
    .sidebar {
        width: 300px;
        background-color: #2c3e50;
        color: white;
        padding: 20px;
        position: fixed;
        left: -300px;
        top: 0;
        height: 100vh;
        transition: left 0.3s;
        z-index: 1000;
    }
    
    .sidebar.active {
        left: 0;
    }
    
    .sidebar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 20px;
        border-bottom: 1px solid #34495e;
    }
    
    .close-sidebar {
        background: none;
        border: none;
        color: white;
        font-size: 24px;
        cursor: pointer;
    }
    
    .new-chat-btn {
        background-color: #3498db;
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 8px;
        width: 100%;
        margin-bottom: 20px;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    
    .new-chat-btn:hover {
        background-color: #2980b9;
    }
    
    .chat-history {
        flex: 1;
        overflow-y: auto;
    }
    
    .chat-history-item {
        padding: 12px;
        margin-bottom: 8px;
        border-radius: 8px;
        cursor: pointer;
        transition: background-color 0.2s;
        border: 1px solid transparent;
    }
    
    .chat-history-item:hover {
        background-color: #34495e;
    }
    
    .chat-history-item.active {
        background-color: #3498db;
        border-color: #2980b9;
    }
    
    .chat-history-title {
        font-weight: 500;
        margin-bottom: 4px;
        cursor: pointer;
        flex: 1;
    }
    
    .chat-history-date {
        font-size: 0.8em;
        color: #bdc3c7;
    }
    
    .chat-history-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
    }
    
    .chat-title-input {
        background: transparent;
        border: none;
        color: white;
        font-weight: 500;
        font-size: inherit;
        width: 100%;
        padding: 0;
        margin: 0;
        outline: none;
        cursor: inherit;
    }
    
    .chat-title-input:focus {
        background-color: #34495e;
        padding: 2px 6px;
        border-radius: 4px;
    }
    
    .edit-title-btn, .delete-btn {
        background: none;
        border: none;
        color: #bdc3c7;
        font-size: 12px;
        cursor: pointer;
        padding: 2px 4px;
        border-radius: 3px;
        opacity: 0;
        transition: opacity 0.2s;
        margin-left: 4px;
    }
    
    .chat-history-item:hover .edit-title-btn,
    .chat-history-item:hover .delete-btn {
        opacity: 1;
    }
    
    .edit-title-btn:hover {
        background-color: #34495e;
        color: white;
    }
    
    .delete-btn:hover {
        background-color: #e74c3c;
        color: white;
    }
    
    .main-title-container {
        display: flex;
        align-items: center;
        gap: 10px;
        flex: 1;
    }
    
    .main-title-input {
        background: transparent;
        border: none;
        color: #2c3e50;
        font-size: 1.5rem;
        font-weight: normal;
        padding: 0;
        margin: 0;
        outline: none;
        flex: 1;
    }
    
    .main-title-input:focus {
        background-color: #f8f9fa;
        padding: 4px 8px;
        border-radius: 4px;
        border: 1px solid #3498db;
    }
    
    .main-edit-title-btn {
        background: none;
        border: none;
        color: #6c757d;
        font-size: 16px;
        cursor: pointer;
        padding: 4px 6px;
        border-radius: 4px;
        opacity: 0.7;
        transition: opacity 0.2s, background-color 0.2s;
    }
    
    .main-title-container:hover .main-edit-title-btn {
        opacity: 1;
    }
    
    .main-edit-title-btn:hover {
        background-color: #e9ecef;
        color: #495057;
    }
    
    .hamburger-menu {
        background: none;
        border: none;
        color: #2c3e50;
        font-size: 24px;
        cursor: pointer;
        padding: 8px;
        margin-right: 15px;
    }
    
    .overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: none;
        z-index: 999;
    }
    
    .overlay.active {
        display: block;
    }
</style>
{% endblock %}

{% block content %}
{% csrf_token %}
<div class="overlay" id="overlay"></div>

<div class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <h5>„ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥</h5>
        <button class="close-sidebar" id="closeSidebar">√ó</button>
    </div>
    <button class="new-chat-btn" id="newChatBtn">Êñ∞„Åó„ÅÑ„ÉÅ„É£„ÉÉ„Éà</button>
    <div class="chat-history" id="chatHistory">
        <!-- „ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô -->
    </div>
</div>

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex align-items-center mb-3">
                <button class="hamburger-menu" id="hamburgerMenu">‚ò∞</button>
                <div class="main-title-container">
                    <input type="text" class="main-title-input" id="mainTitleInput" value="{% if session %}{{ session.title }}{% else %}Êñ∞„Åó„ÅÑ„ÉÅ„É£„ÉÉ„Éà{% endif %}" readonly>
                    <button class="main-edit-title-btn" id="mainEditTitleBtn" title="„Çø„Ç§„Éà„É´„ÇíÁ∑®ÈõÜ">‚úé</button>
                </div>
            </div>
            
            <div class="chat-container">
                <div class="messages-container" id="messagesContainer">
                    {% if session and session.messages.exists %}
                        {% for message in session.messages.all %}
                            <div class="message {{ message.role }}">
                                <div class="message-content">
                                    {{ message.content }}
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="message assistant">
                            <div class="message-content">
                                {% if init_message %}
                                    {{ init_message }}
                                {% else %}
                                    „Åì„Çì„Å´„Å°„ÅØ„ÄÇ„Ç´„Ç¶„É≥„Çª„É©„ÉºAI„ÅÆ„Éü„É©„Ç§„Åß„Åô„ÄÇ‰ªäÊó•„ÅØ„Å©„ÅÆ„Çà„ÅÜ„Å™„Åì„Å®„Åß„ÅäÊÇ©„Åø„Åß„Åó„Çá„ÅÜ„ÅãÔºü
                                {% endif %}
                            </div>
                        </div>
                    {% endif %}
                    
                    <div class="message assistant">
                        <div class="typing-indicator" id="typingIndicator">
                            <div class="typing-dots">
                                <div class="typing-dot"></div>
                                <div class="typing-dot"></div>
                                <div class="typing-dot"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="message-input-container">
                    <textarea 
                        class="message-input" 
                        id="messageInput" 
                        placeholder="„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ..."
                        rows="1"
                    ></textarea>
                    <button class="send-button" id="sendButton">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                            <path d="M15.854.146a.5.5 0 0 1 .11.54l-5.819 14.547a.75.75 0 0 1-1.329.124l-3.178-4.995L.643 7.184a.75.75 0 0 1 .124-1.33L15.314.037a.5.5 0 0 1 .54.11ZM6.636 10.07l2.761 4.338L14.13 2.576 6.636 10.07Zm6.787-8.201L1.591 6.602l4.339 2.76 7.494-7.493Z"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const messagesContainer = document.getElementById('messagesContainer');
const messageInput = document.getElementById('messageInput');
const sendButton = document.getElementById('sendButton');
const typingIndicator = document.getElementById('typingIndicator');
const hamburgerMenu = document.getElementById('hamburgerMenu');
const sidebar = document.getElementById('sidebar');
const closeSidebar = document.getElementById('closeSidebar');
const overlay = document.getElementById('overlay');
const newChatBtn = document.getElementById('newChatBtn');
const chatHistory = document.getElementById('chatHistory');
const mainTitleInput = document.getElementById('mainTitleInput');
const mainEditTitleBtn = document.getElementById('mainEditTitleBtn');

let currentSessionId = {% if session %}"{{ session.id }}"{% else %}null{% endif %};
let isTyping = false;

// „Çµ„Ç§„Éâ„Éê„Éº„ÅÆÈñãÈñâ
hamburgerMenu.addEventListener('click', () => {
    sidebar.classList.add('active');
    overlay.classList.add('active');
});

closeSidebar.addEventListener('click', closeSidebarFunc);
overlay.addEventListener('click', closeSidebarFunc);

function closeSidebarFunc() {
    sidebar.classList.remove('active');
    overlay.classList.remove('active');
}

// „É°„ÉÉ„Çª„Éº„Ç∏ÈÄÅ‰ø°
sendButton.addEventListener('click', sendMessage);
messageInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
});

// „ÉÜ„Ç≠„Çπ„Éà„Ç®„É™„Ç¢„ÅÆËá™Âãï„É™„Çµ„Ç§„Ç∫
messageInput.addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = (this.scrollHeight) + 'px';
});

function sendMessage() {
    const message = messageInput.value.trim();
    if (!message || isTyping) {
        console.log('Message empty or typing:', message, isTyping);
        return;
    }
    
    // Êñ∞„Åó„ÅÑ„ÉÅ„É£„ÉÉ„Éà„ÅÆÂ†¥Âêà„ÅØ„Çª„ÉÉ„Ç∑„Éß„É≥ID„Åånull„Åß„ÇÇOK
    if (!currentSessionId) {
        console.log('New chat session - no session ID yet');
    }
    
    console.log('Sending message:', message, 'Session ID:', currentSessionId);
    
    const csrfToken = getCookie('csrftoken');
    console.log('CSRF Token:', csrfToken);
    
    // „É¶„Éº„Ç∂„Éº„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫
    addMessage(message, 'user');
    messageInput.value = '';
    messageInput.style.height = 'auto';
    
    // ÈÄÅ‰ø°„Éú„Çø„É≥„ÇíÁÑ°ÂäπÂåñ
    sendButton.disabled = true;
    isTyping = true;
    
    // „Çø„Ç§„Éî„É≥„Ç∞„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº„ÇíË°®Á§∫
    typingIndicator.style.display = 'block';
    scrollToBottom();
    
    // „É°„ÉÉ„Çª„Éº„Ç∏„ÇíÈÄÅ‰ø°
    const url = currentSessionId ? `/chat/send/${currentSessionId}/` : '/chat/send/new/';
    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            message: message,
            streaming: true
        })
    })
    .then(response => {
        console.log('Response status:', response.status);
        console.log('Response headers:', response.headers);
        
        if (!response.ok) {
            return response.text().then(text => {
                console.error('Response text:', text);
                throw new Error(`HTTP error! status: ${response.status}, text: ${text}`);
            });
        }
        return response.body.getReader();
    })
    .then(reader => {
        console.log('Reader obtained, starting to read stream');
        // „Çø„Ç§„Éî„É≥„Ç∞„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº„ÇíÈùûË°®Á§∫
        typingIndicator.style.display = 'none';
        
        // Á©∫„ÅÆ„Ç¢„Ç∑„Çπ„Çø„É≥„Éà„É°„ÉÉ„Çª„Éº„Ç∏„Çí‰ΩúÊàê
        const messageDiv = addMessage('...', 'assistant');
        const messageContent = messageDiv.querySelector('.message-content');
        
        // „Çπ„Éà„É™„Éº„Éü„É≥„Ç∞„É¨„Çπ„Éù„É≥„Çπ„ÇíÂá¶ÁêÜ
        function pump() {
            return reader.read().then(({ done, value }) => {
                if (done) {
                    console.log('Stream finished');
                    // ÊúÄÁµÇÁöÑ„Å´[]„ÅåÊÆã„Å£„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØÂâäÈô§
                    messageContent.textContent = messageContent.textContent.replace(/\[.*?\]\s*/g, '');
                    isTyping = false;
                    sendButton.disabled = false;
                    return;
                }
                
                const chunk = new TextDecoder().decode(value);
                console.log('Received chunk:', chunk);
                const lines = chunk.split('\n');
                
                for (const line of lines) {
                    if (line.trim() === '') continue; // Á©∫Ë°å„Çí„Çπ„Ç≠„ÉÉ„Éó
                    
                    if (line.startsWith('data: ')) {
                        const data = line.substring(6).trim();
                        if (data === '[DONE]') {
                            console.log('Stream done signal received');
                            // ÊúÄÁµÇÁöÑ„Å´[]„ÅåÊÆã„Å£„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØÂâäÈô§
                            messageContent.textContent = messageContent.textContent.replace(/\[.*?\]\s*/g, '');
                            isTyping = false;
                            sendButton.disabled = false;
                            return;
                        }
                        
                        if (data === '') continue; // Á©∫„ÅÆ„Éá„Éº„Çø„Çí„Çπ„Ç≠„ÉÉ„Éó
                        
                        try {
                            const parsed = JSON.parse(data);
                            console.log('Parsed data:', parsed);
                            if (parsed.content) {
                                // „Åù„ÅÆ„Åæ„ÅæËøΩÂä†Ôºà„Éê„ÉÉ„ÇØ„Ç®„É≥„Éâ„ÅßÊó¢„Å´Âá¶ÁêÜÊ∏à„ÅøÔºâ
                                if (parsed.content.trim() !== '') {
                                    // ÊúÄÂàù„ÅÆ„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÅåÊù•„Åü„Çâ„Äå...„Äç„ÇíÁΩÆ„ÅçÊèõ„Åà„Çã
                                    if (messageContent.textContent === '...') {
                                        messageContent.textContent = parsed.content;
                                    } else {
                                        messageContent.textContent += parsed.content;
                                    }
                                    scrollToBottom();
                                }
                            } else if (parsed.session_id) {
                                // Êñ∞„Åó„ÅÑ„Çª„ÉÉ„Ç∑„Éß„É≥„Åå‰ΩúÊàê„Åï„Çå„ÅüÂ†¥Âêà
                                if (!currentSessionId) {
                                    currentSessionId = parsed.session_id;
                                    // URL„ÇíÊõ¥Êñ∞
                                    window.history.replaceState({}, '', `/chat/${currentSessionId}/`);
                                    // „Çµ„Ç§„Éâ„Éê„Éº„ÇíÊõ¥Êñ∞
                                    loadChatHistory();
                                }
                            } else if (parsed.error) {
                                messageContent.textContent = '„Ç®„É©„Éº: ' + parsed.error;
                                scrollToBottom();
                            }
                        } catch (e) {
                            console.log('JSON parse error:', e, 'Data:', data);
                            // Á©∫„ÅÆ„Éá„Éº„Çø„ÇÑ„Éë„Éº„Çπ„Åß„Åç„Å™„ÅÑ„Éá„Éº„Çø„ÅØÁÑ°Ë¶ñ
                        }
                    }
                }
                
                return pump();
            }).catch(error => {
                console.error('Pump error:', error);
                isTyping = false;
                sendButton.disabled = false;
                if (messageContent.textContent === '') {
                    messageContent.textContent = '„Çπ„Éà„É™„Éº„Éü„É≥„Ç∞‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ';
                }
            });
        }
        
        return pump();
    })
    .catch(error => {
        console.error('Error:', error);
        typingIndicator.style.display = 'none';
        addMessage('Áî≥„ÅóË®≥„ÅÇ„Çä„Åæ„Åõ„Çì„Åå„ÄÅ„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + error.message, 'assistant');
        isTyping = false;
        sendButton.disabled = false;
    });
}

function addMessage(content, role) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${role}`;
    
    const messageContent = document.createElement('div');
    messageContent.className = 'message-content';
    messageContent.textContent = content;
    
    messageDiv.appendChild(messageContent);
    messagesContainer.insertBefore(messageDiv, messagesContainer.lastElementChild);
    
    scrollToBottom();
    return messageDiv;
}

function scrollToBottom() {
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    
    // CSRF„Éà„Éº„ÇØ„É≥„ÅåË¶ã„Å§„Åã„Çâ„Å™„ÅÑÂ†¥Âêà„ÄÅDOM„Åã„ÇâÂèñÂæó„ÇíË©¶„Åø„Çã
    if (!cookieValue) {
        const csrfElement = document.querySelector('[name=csrfmiddlewaretoken]');
        if (csrfElement) {
            cookieValue = csrfElement.value;
        }
    }
    
    return cookieValue;
}

// Êñ∞„Åó„ÅÑ„ÉÅ„É£„ÉÉ„Éà
newChatBtn.addEventListener('click', () => {
    window.location.href = '/chat/new/';
});

// „ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥„ÅÆË™≠„ÅøËæº„Åø
function loadChatHistory() {
    fetch('/chat/history/')
        .then(response => response.json())
        .then(sessions => {
            chatHistory.innerHTML = '';
            sessions.forEach(session => {
                const item = document.createElement('div');
                item.className = 'chat-history-item';
                if (session.id === currentSessionId) {
                    item.classList.add('active');
                }
                
                item.innerHTML = `
                    <div class="chat-history-content">
                        <div style="flex: 1;">
                            <input type="text" class="chat-title-input" value="${session.title}" data-session-id="${session.id}" readonly>
                            <div class="chat-history-date">${new Date(session.updated_at).toLocaleDateString('ja-JP')}</div>
                        </div>
                        <div>
                            <button class="edit-title-btn" title="„Çø„Ç§„Éà„É´„ÇíÁ∑®ÈõÜ" data-session-id="${session.id}">‚úé</button>
                            <button class="delete-btn" title="ÂâäÈô§" data-session-id="${session.id}">üóë</button>
                        </div>
                    </div>
                `;
                
                const titleInput = item.querySelector('.chat-title-input');
                const editBtn = item.querySelector('.edit-title-btn');
                const deleteBtn = item.querySelector('.delete-btn');
                
                // „ÉÅ„É£„ÉÉ„ÉàÂ±•Ê≠¥„Ç¢„Ç§„ÉÜ„É†„ÇØ„É™„ÉÉ„ÇØÔºà„Çª„ÉÉ„Ç∑„Éß„É≥ÁßªÂãïÔºâ
                item.addEventListener('click', (e) => {
                    // Á∑®ÈõÜ„Éú„Çø„É≥„ÇÑÂâäÈô§„Éú„Çø„É≥„Åå„ÇØ„É™„ÉÉ„ÇØ„Åï„Çå„ÅüÂ†¥Âêà„ÅØ„Çª„ÉÉ„Ç∑„Éß„É≥ÁßªÂãï„Åó„Å™„ÅÑ
                    if (e.target === editBtn || e.target === deleteBtn) {
                        return;
                    }
                    // Á∑®ÈõÜ„É¢„Éº„Éâ‰∏≠„ÅÆÂ†¥Âêà„ÅØ„Çª„ÉÉ„Ç∑„Éß„É≥ÁßªÂãï„Åó„Å™„ÅÑ
                    if (!titleInput.readOnly) {
                        return;
                    }
                    window.location.href = `/chat/${session.id}/`;
                });
                
                // Á∑®ÈõÜ„Éú„Çø„É≥„ÇØ„É™„ÉÉ„ÇØ
                editBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    titleInput.readOnly = false;
                    titleInput.focus();
                    titleInput.select();
                });
                
                // „Çø„Ç§„Éà„É´Á∑®ÈõÜÂÆå‰∫Ü
                titleInput.addEventListener('blur', () => {
                    if (!titleInput.readOnly) {
                        saveTitleChange(session.id, titleInput.value.trim());
                    }
                });
                
                titleInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        titleInput.blur();
                    } else if (e.key === 'Escape') {
                        titleInput.value = session.title;
                        titleInput.readOnly = true;
                    }
                });
                
                // ÂâäÈô§„Éú„Çø„É≥„ÇØ„É™„ÉÉ„ÇØ
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (confirm(`„Äå${session.title}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü„Åì„ÅÆÊìç‰Ωú„ÅØÂÖÉ„Å´Êàª„Åõ„Åæ„Åõ„Çì„ÄÇ`)) {
                        deleteSession(session.id);
                    }
                });
                
                chatHistory.appendChild(item);
            });
        })
        .catch(error => console.error('Error loading chat history:', error));
}

// „Çø„Ç§„Éà„É´Â§âÊõ¥„Çí‰øùÂ≠ò
function saveTitleChange(sessionId, newTitle) {
    if (!newTitle) {
        alert('„Çø„Ç§„Éà„É´„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
        loadChatHistory(); // ÂÖÉ„Å´Êàª„Åô
        return;
    }
    
    const csrfToken = getCookie('csrftoken');
    
    fetch(`/chat/update-title/${sessionId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            title: newTitle
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('„Çø„Ç§„Éà„É´„ÅåÊõ¥Êñ∞„Åï„Çå„Åæ„Åó„Åü');
            loadChatHistory(); // Â±•Ê≠¥„ÇíÂÜçË™≠„ÅøËæº„Åø
        } else {
            alert('„Çø„Ç§„Éà„É´„ÅÆÊõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + (data.error || '‰∏çÊòé„Å™„Ç®„É©„Éº'));
            loadChatHistory(); // ÂÖÉ„Å´Êàª„Åô
        }
    })
    .catch(error => {
        console.error('Error updating title:', error);
        alert('„Çø„Ç§„Éà„É´„ÅÆÊõ¥Êñ∞‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
        loadChatHistory(); // ÂÖÉ„Å´Êàª„Åô
    });
}

// „É°„Ç§„É≥„Çø„Ç§„Éà„É´Á∑®ÈõÜÊ©üËÉΩ
mainEditTitleBtn.addEventListener('click', () => {
    if (currentSessionId) {
        mainTitleInput.readOnly = false;
        mainTitleInput.focus();
        mainTitleInput.select();
    }
});

mainTitleInput.addEventListener('blur', () => {
    if (!mainTitleInput.readOnly && currentSessionId) {
        saveMainTitleChange(currentSessionId, mainTitleInput.value.trim());
    }
});

mainTitleInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        e.preventDefault();
        mainTitleInput.blur();
    } else if (e.key === 'Escape') {
        // ÂÖÉ„ÅÆÂÄ§„Å´Êàª„Åô
        mainTitleInput.value = {% if session %}"{{ session.title }}"{% else %}"Êñ∞„Åó„ÅÑ„ÉÅ„É£„ÉÉ„Éà"{% endif %};
        mainTitleInput.readOnly = true;
    }
});

// „É°„Ç§„É≥„Çø„Ç§„Éà„É´Â§âÊõ¥„Çí‰øùÂ≠ò
function saveMainTitleChange(sessionId, newTitle) {
    if (!newTitle) {
        alert('„Çø„Ç§„Éà„É´„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
        mainTitleInput.value = {% if session %}"{{ session.title }}"{% else %}"Êñ∞„Åó„ÅÑ„ÉÅ„É£„ÉÉ„Éà"{% endif %};
        mainTitleInput.readOnly = true;
        return;
    }
    
    const csrfToken = getCookie('csrftoken');
    
    fetch(`/chat/update-title/${sessionId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            title: newTitle
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('„É°„Ç§„É≥„Çø„Ç§„Éà„É´„ÅåÊõ¥Êñ∞„Åï„Çå„Åæ„Åó„Åü');
            mainTitleInput.readOnly = true;
            loadChatHistory(); // „Çµ„Ç§„Éâ„Éê„Éº„ÅÆÂ±•Ê≠¥„ÇÇÊõ¥Êñ∞
        } else {
            alert('„Çø„Ç§„Éà„É´„ÅÆÊõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + (data.error || '‰∏çÊòé„Å™„Ç®„É©„Éº'));
            mainTitleInput.value = {% if session %}"{{ session.title }}"{% else %}"Êñ∞„Åó„ÅÑ„ÉÅ„É£„ÉÉ„Éà"{% endif %};
            mainTitleInput.readOnly = true;
        }
    })
    .catch(error => {
        console.error('Error updating main title:', error);
        alert('„Çø„Ç§„Éà„É´„ÅÆÊõ¥Êñ∞‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
        mainTitleInput.value = {% if session %}"{{ session.title }}"{% else %}"Êñ∞„Åó„ÅÑ„ÉÅ„É£„ÉÉ„Éà"{% endif %};
        mainTitleInput.readOnly = true;
    });
}

// „Çª„ÉÉ„Ç∑„Éß„É≥ÂâäÈô§
function deleteSession(sessionId) {
    const csrfToken = getCookie('csrftoken');
    
    fetch(`/chat/delete/${sessionId}/`, {
        method: 'DELETE',
        headers: {
            'X-CSRFToken': csrfToken
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('„Çª„ÉÉ„Ç∑„Éß„É≥„ÅåÂâäÈô§„Åï„Çå„Åæ„Åó„Åü');
            // ÂâäÈô§„Åï„Çå„Åü„Çª„ÉÉ„Ç∑„Éß„É≥„ÅåÁèæÂú®„ÅÆ„Çª„ÉÉ„Ç∑„Éß„É≥„ÅÆÂ†¥Âêà„ÄÅ„Éà„ÉÉ„Éó„Éö„Éº„Ç∏„Å´„É™„ÉÄ„Ç§„É¨„ÇØ„Éà
            if (sessionId === currentSessionId) {
                window.location.href = '/chat/';
            } else {
                // Â±•Ê≠¥„ÇíÂÜçË™≠„ÅøËæº„Åø
                loadChatHistory();
            }
        } else {
            alert('„Çª„ÉÉ„Ç∑„Éß„É≥„ÅÆÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + (data.error || '‰∏çÊòé„Å™„Ç®„É©„Éº'));
        }
    })
    .catch(error => {
        console.error('Error deleting session:', error);
        alert('„Çª„ÉÉ„Ç∑„Éß„É≥„ÅÆÂâäÈô§‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
    });
}

// ÂàùÊúüÂåñ
document.addEventListener('DOMContentLoaded', () => {
    loadChatHistory();
    scrollToBottom();
});
</script>
{% endblock %}