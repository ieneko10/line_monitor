{% extends "base.html" %}

{% block title %}å¯¾è©±ç·´ç¿’ï¼š{{ topic.name }} - {{ block.super }}{% endblock %}

{% block extra_head %}
<style>
.chat-container {
    display: flex;
    gap: 20px;
}
.chat-main {
    flex-grow: 1;
    min-width: 0; /* flexã‚¢ã‚¤ãƒ†ãƒ ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼ã‚’é˜²ã */
}
.chat-sidebar {
    width: 300px;
    flex-shrink: 0;
    border-left: 1px solid #ccc;
    padding-left: 20px;
}
#chat-log {
    max-height: 400px; /* å›ºå®šé«˜ã•ã‹ã‚‰æœ€å¤§é«˜ã•ã¸å¤‰æ›´ */
    height: 60vh; /* ç”»é¢ã®é«˜ã•ã«å¯¾ã™ã‚‹å‰²åˆã§é«˜ã•ã‚’è¨­å®š */
    border: 1px solid #ccc;
    overflow-y: scroll;
    padding: 10px;
    margin-bottom: 10px;
    overflow-wrap: break-word;
}
#chat-form .form-row {
    display: flex;
    align-items: stretch; /* é«˜ã•ã‚’æƒãˆã‚‹ãŸã‚ã«stretchã«å¤‰æ›´ */
    gap: 5px;
}
#user-message-input {
    flex-grow: 1;
    resize: vertical;
    font-size: 16px; /* ãƒ¢ãƒã‚¤ãƒ«ã§ã®è‡ªå‹•ã‚ºãƒ¼ãƒ é˜²æ­¢ */
}
#submit-chat-button {
    flex-shrink: 0;
}
.dialogue-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 2em;
    flex-wrap: wrap; /* ç”»é¢ãŒå°ã•ã„å ´åˆã«æŠ˜ã‚Šè¿”ã™ */
    gap: 1em;
}

/* ç°¡å˜ãªCSSã‚¹ãƒ”ãƒŠãƒ¼ */
.spinner {
    border: 4px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    border-top: 4px solid #fff;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin-left: auto;
    margin-right: auto;
}
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* æˆ¦ç•¥è¡¨ç¤ºã‚¨ãƒªã‚¢ */
#strategy-area {
    margin-top: 10px;
    padding: 10px;
    background-color: #f9f9f9;
    border-radius: 5px;
    min-height: 100px;
    white-space: pre-wrap;
    overflow-wrap: break-word;
    word-break: break-word;
    display: flex;
    justify-content: center;
    align-items: center;
    text-align: center;
}
.strategy-placeholder {
    color: #888;
    font-style: italic;
    font-size: 0.95em;
}
#strategy-area ul {
    list-style-type: none;
    padding-left: 0;
    width: 100%;
    text-align: left;
}
#strategy-area ul li {
    margin-bottom: 15px;
    border: 1px solid #eee;
    padding: 10px;
    border-radius: 4px;
    background-color: #fff;
}
#strategy-area ul li h5 {
    margin-top: 0;
    margin-bottom: 5px;
    font-size: 1.1em;
    color: #337ab7;
}
#strategy-area ul li p {
    white-space: pre-wrap;
    margin: 0;
    font-size: 0.95em;
    background-color: transparent;
    padding: 0;
    border-radius: 0;
}

.evaluation-box {
    background: #e3f2fd;
    border-left: 4px solid #2196F3;
    padding: 10px;
    margin: 10px 0;
    border-radius: 4px;
    font-size: 0.9em;
}
/* ã‚¹ã‚³ã‚¢0: èµ¤ç³» */
.evaluation-box.score-0 {
    background: #ffebee;
    border-left-color: #f44336;
}
.evaluation-box.score-0 .score {
    color: #c62828;
}
.evaluation-box.score-0 .score:hover {
    color: #b71c1c;
}
.evaluation-box.score-0 .reason {
    border-top-color: #ef9a9a;
}
/* ã‚¹ã‚³ã‚¢1: é»„è‰²/ã‚ªãƒ¬ãƒ³ã‚¸ç³» */
.evaluation-box.score-1 {
    background: #fff3e0;
    border-left-color: #ff9800;
}
.evaluation-box.score-1 .score {
    color: #ef6c00;
}
.evaluation-box.score-1 .score:hover {
    color: #e65100;
}
.evaluation-box.score-1 .reason {
    border-top-color: #ffcc80;
}
/* ã‚¹ã‚³ã‚¢2: ç·‘ç³» */
.evaluation-box.score-2 {
    background: #e8f5e9;
    border-left-color: #4caf50;
}
.evaluation-box.score-2 .score {
    color: #2e7d32;
}
.evaluation-box.score-2 .score:hover {
    color: #1b5e20;
}
.evaluation-box.score-2 .reason {
    border-top-color: #a5d6a7;
}
.evaluation-box .score {
    font-weight: bold;
    color: #1976D2;
    font-size: 1.1em;
    cursor: pointer;
    user-select: none;
    display: flex;
    align-items: center;
    gap: 5px;
}
.evaluation-box .score:hover {
    color: #0d47a1;
}
.evaluation-box .score::after {
    content: 'â–¼';
    font-size: 0.8em;
    transition: transform 0.3s ease;
}
.evaluation-box .score.collapsed::after {
    transform: rotate(-90deg);
}
.evaluation-box .reason {
    margin-top: 10px;
    padding-top: 10px;
    border-top: 1px solid #90caf9;
    color: #333;
    max-height: 500px;
    overflow: hidden;
    transition: max-height 0.3s ease, opacity 0.3s ease;
    opacity: 1;
}
.evaluation-box .reason.hidden {
    max-height: 0;
    opacity: 0;
    margin-top: 0;
    padding-top: 0;
    border-top: none;
}

/* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
@media (max-width: 768px) {
    .chat-container {
        flex-direction: column;
    }
    .chat-sidebar {
        width: 100%;
        border-left: none;
        padding-left: 0;
        border-top: 1px solid #ccc;
        padding-top: 20px;
        margin-top: 20px;
    }
    .dialogue-actions {
        flex-direction: column;
        align-items: flex-start;
    }
    #chat-log {
        height: 50vh; /* ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã§ã¯é«˜ã•ã‚’èª¿æ•´ */
    }
}

/* éŸ³å£°ãƒãƒ£ãƒƒãƒˆãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.voice-chat-button {
    background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
    color: white !important;
    padding: 12px 20px !important;
    border-radius: 8px;
    font-weight: bold;
    font-size: 1.1em;
    text-decoration: none !important;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    box-shadow: 0 4px 15px rgba(255, 107, 53, 0.4);
    transition: all 0.3s ease;
    border: 2px solid #ff6b35;
}

.voice-chat-button:hover {
    background: linear-gradient(135deg, #f7931e 0%, #ff6b35 100%);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(255, 107, 53, 0.6);
}

.voice-chat-button .emoji {
    font-size: 1.3em;
    animation: pulse-icon 2s ease-in-out infinite;
}

@keyframes pulse-icon {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
}
</style>
{% endblock %}

{% block content %}
  <div class="chat-container">
    <div class="chat-main">

            <div id="chat-log">
        {% if dialogue_logs %}
          {% for log_entry in dialogue_logs %}
            <p style="overflow-wrap: break-word; word-break: break-word;">
              <strong>
                {% if log_entry.speaker == 'user' %}ã‚ãªãŸ (ã‚«ã‚¦ãƒ³ã‚»ãƒ©ãƒ¼){% else %}ç›¸è«‡è€… (AI){% endif %}:
              </strong>
{{ log_entry.message|linebreaksbr }}
              <span style="font-size: 0.8em; color: #777;">
                ({{ log_entry.timestamp|date:"H:i:s" }})
              </span>
            </p>
          {% endfor %}
        {% elif is_new_session %}
            <p style="overflow-wrap: break-word; word-break: break-word;">
              <strong>ç›¸è«‡è€… (AI):</strong>
              ã“ã‚“ã«ã¡ã¯ã€‚ä»Šæ—¥ã¯ã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™ã€‚
            </p>
        {% else %}
            <p id="no-dialogue-message">ã¾ã å¯¾è©±ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
        {% endif %}
      </div>

      <form id="chat-form" method="post" action="{% if is_new_session %}{% if is_illegal_job %}{% url 'dialogues:dialogue_chat_new_illegal' illegal_topic_id=topic.id %}{% else %}{% url 'dialogues:dialogue_chat_new' topic_id=topic.id %}{% endif %}{% else %}{% url 'dialogues:dialogue_chat' session_id=session.id %}{% endif %}">
        {% csrf_token %}
        <div class="form-row">
          <textarea name="message" id="user-message-input" rows="3" placeholder="ã‚«ã‚¦ãƒ³ã‚»ãƒ©ãƒ¼ã¨ã—ã¦ã®å¿œç­”ã‚’å…¥åŠ›..." required></textarea>
          <button type="submit" id="submit-chat-button" class="button">é€ä¿¡<br><span style="font-size:0.8em; color:#ffffff;">(Ctrl+Enter)</span></button>
        </div>
      </form>
    </div>

    <div id="sidebar-strategy" class="chat-sidebar">
        <h3>æˆ¦ç•¥ã¨å¿œç­”ä¾‹</h3>
        <button id="generate-strategy-btn">å¿œç­”ä¾‹ã‚’ç”Ÿæˆã™ã‚‹</button>
        <div id="strategy-area">
            <p class="strategy-placeholder">ã“ã“ã«æˆ¦ç•¥ãƒ»å¿œç­”ä¾‹ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
        </div>
    </div>
  </div>

  <hr style="margin-top:2em;">

  <div class="dialogue-actions">
    <div style="display: flex; gap: 10px; align-items: center;">
      {% if not is_new_session and session %}
      <form id="end-dialogue-form" method="post" action="{% url 'dialogues:end_dialogue' session_id=session.id %}" style="margin: 0;">
        {% csrf_token %}
        <button type="submit" id="end-dialogue-button"
          {% if not has_user_message %}disabled style="background-color: #ccc; color: #666; cursor: not-allowed;" onclick="return false;"{% else %}onclick="return confirm('å¯¾è©±ã‚’çµ‚äº†ã—ã¾ã™ã‹ï¼Ÿ');"{% endif %}
        >å¯¾è©±ã‚’çµ‚äº†ã—ã¦è©•ä¾¡ã‚’è¦‹ã‚‹</button>
      </form>
      <form id="reset-dialogue-form" method="post" action="{% url 'dialogues:reset_dialogue' session_id=session.id %}" style="margin: 0;">
        {% csrf_token %}
        <button type="submit" id="reset-dialogue-button"
          {% if not has_user_message %}disabled style="background-color: #ccc; color: #666; cursor: not-allowed;" onclick="return false;"{% else %}onclick="return confirm('æœ¬å½“ã«å¯¾è©±å±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ');"{% endif %}
        >å¯¾è©±å±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
      </form>
      {% else %}
      <!-- æ–°è¦ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®å ´åˆ: ãƒœã‚¿ãƒ³ã®ã¿é…ç½®ã—ã€ãƒ•ã‚©ãƒ¼ãƒ ã¯å¾Œã§JSã§ç”Ÿæˆ -->
      <div id="button-container">
        <button type="button" id="end-dialogue-button" disabled style="background-color: #ccc; color: #666; cursor: not-allowed;">å¯¾è©±ã‚’çµ‚äº†ã—ã¦è©•ä¾¡ã‚’è¦‹ã‚‹</button>
        <button type="button" id="reset-dialogue-button" disabled style="background-color: #ccc; color: #666; cursor: not-allowed;">å¯¾è©±å±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
      </div>
      {% endif %}
    </div>
    {% if VOICE_CHAT_ENABLED %}
    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
      {% if session %}
        <p><a href="{% url 'dialogues:voice_chat' %}?session_id={{ session.id }}" class="voice-chat-button"><span class="emoji">ğŸ¤</span> éŸ³å£°ãƒãƒ£ãƒƒãƒˆ(Î²ç‰ˆ)</a></p>
      {% else %}
        {% if is_illegal_job %}
        <p><a href="{% url 'dialogues:voice_chat' %}?is_illegal_job=true" class="voice-chat-button"><span class="emoji">ğŸ¤</span> éŸ³å£°ãƒãƒ£ãƒƒãƒˆ(Î²ç‰ˆ)</a></p>
        {% else %}
        <p><a href="{% url 'dialogues:voice_chat' %}" class="voice-chat-button"><span class="emoji">ğŸ¤</span> éŸ³å£°ãƒãƒ£ãƒƒãƒˆ(Î²ç‰ˆ)</a></p>
        {% endif %}
      {% endif %}
    </div>
    {% endif %}
  </div>
{% endblock %}

{% block body_bottom_elements %}
<div id="loading-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.65); z-index: 10000; justify-content: center; align-items: center; flex-direction: column; color: white; font-size: 1.5em; text-align: center;">
    <div style="padding: 20px;">
        <p>è©•ä¾¡ã‚’ç”Ÿæˆã—ã¦ã„ã¾ã™...</p>
        <p style="font-size: 0.8em;">ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚(æœ€å¤§1åˆ†ç¨‹åº¦)</p>
        <div class="spinner" style="margin-top:20px;"></div>
    </div>
</div>
{% endblock %}


{% block extra_js %}
<script>
    const chatLog = document.getElementById('chat-log');
    const chatForm = document.getElementById('chat-form');
    const messageInput = document.getElementById('user-message-input');
    let sessionId = "{{ session.id|default:'' }}";  // let ã«å¤‰æ›´ã—ã¦æ›´æ–°å¯èƒ½ã«ã™ã‚‹
    const topicId = "{{ topic.id }}";
    const isNewSession = {% if is_new_session %}true{% else %}false{% endif %};
    const isIllegalJob = {% if is_illegal_job %}true{% else %}false{% endif %};
    const csrfToken = "{{ csrf_token }}"; // POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ã«ä½¿ç”¨

    const submitChatButton = document.getElementById('submit-chat-button'); // âœ… é€ä¿¡ãƒœã‚¿ãƒ³ã‚’å–å¾—
    const generateStrategyBtn = document.getElementById('generate-strategy-btn'); // æˆ¦ç•¥ç”Ÿæˆãƒœã‚¿ãƒ³
    const strategyArea = document.getElementById('strategy-area');

    // è©•ä¾¡çµæœè¡¨ç¤ºç”¨ã®å¤‰æ•°
    let currentEvaluationScore = null;
    let currentEvaluationReason = null;

    // ãƒãƒ£ãƒƒãƒˆãƒ­ã‚°ã®è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é–¢æ•°
    function scrollToBottom() {
        if (chatLog) {
            chatLog.scrollTop = chatLog.scrollHeight;
        }
    }
    scrollToBottom(); // åˆæœŸè¡¨ç¤ºæ™‚ã«ã‚‚ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«

    // âœ… è©•ä¾¡çµæœã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°ï¼ˆæŠ˜ã‚ŠãŸãŸã¿å¼ãƒ»ã‚¹ã‚³ã‚¢åˆ¥è‰²åˆ†ã‘ï¼‰
    function addEvaluationToLog(score, reason, insertAfterElement = null) {
        const evalDiv = document.createElement('div');
        evalDiv.className = 'evaluation-box';
        
        // ã‚¹ã‚³ã‚¢ã«å¿œã˜ã¦ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ ï¼ˆ0, 1, 2ï¼‰
        if (score === 0 || score === '0') {
            evalDiv.classList.add('score-0');
        } else if (score === 1 || score === '1') {
            evalDiv.classList.add('score-1');
        } else if (score === 2 || score === '2') {
            evalDiv.classList.add('score-2');
        }
        
        const scoreDiv = document.createElement('div');
        scoreDiv.className = 'score collapsed';
        scoreDiv.textContent = `ğŸ“Š ç™ºè©±è©•ä¾¡: ${score}`;
        
        const reasonDiv = document.createElement('div');
        reasonDiv.className = 'reason hidden';
        reasonDiv.textContent = reason;
        
        // ã‚¯ãƒªãƒƒã‚¯ã§é–‹é–‰
        scoreDiv.addEventListener('click', function() {
            scoreDiv.classList.toggle('collapsed');
            reasonDiv.classList.toggle('hidden');
        });
        
        evalDiv.appendChild(scoreDiv);
        evalDiv.appendChild(reasonDiv);
        
        // âœ… æŒ‡å®šã•ã‚ŒãŸè¦ç´ ã®ç›´å¾Œã«æŒ¿å…¥ã€ã¾ãŸã¯ãƒãƒ£ãƒƒãƒˆãƒ­ã‚°ã®æœ€å¾Œã«è¿½åŠ 
        if (insertAfterElement && insertAfterElement.nextSibling) {
            chatLog.insertBefore(evalDiv, insertAfterElement.nextSibling);
        } else if (insertAfterElement) {
            chatLog.appendChild(evalDiv);
        } else {
            chatLog.appendChild(evalDiv);
        }
        scrollToBottom();
    }

    if (generateStrategyBtn) {
        generateStrategyBtn.addEventListener('click', function() {
            if (!sessionId) {
                strategyArea.innerHTML = '<p>ã¾ãšå¯¾è©±ã‚’é–‹å§‹ã—ã¦ã‹ã‚‰æˆ¦ç•¥ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚</p>';
                return;
            }
            
            strategyArea.innerHTML = '<p>å¿œç­”ä¾‹ã‚’ç”Ÿæˆä¸­ã§ã™...</p>'; // innerHTMLã‚’ä½¿ã£ã¦åˆæœŸåŒ–ã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
            generateStrategyBtn.disabled = true;

            fetch(`/dialogues/session/${sessionId}/generate_strategy/`)
                .then(response => {
                    if (!response.ok) { // ã¾ãšãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ç¢ºèª
                        return response.json().then(errData => { // ã‚¨ãƒ©ãƒ¼ã®å ´åˆã‚‚JSONã‚’æœŸå¾…ã™ã‚‹
                            throw new Error(errData.error || `ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼: ${response.status}`);
                        });
                    }
                    return response.json();
                })
                .then(result => { // result ã¯ {'success': true, 'data': LLMãŒç”Ÿæˆã—ãŸJSONã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ} ã¨ã„ã†å½¢
                    if (result.success && result.data && result.data.strategies) {
                        strategyArea.innerHTML = ''; // è¡¨ç¤ºã‚¨ãƒªã‚¢ã‚’ã‚¯ãƒªã‚¢
                        if (result.data.strategies.length > 0) {
                            const ul = document.createElement('ul');
                            ul.style.listStyleType = 'none';
                            ul.style.paddingLeft = '0';

                            result.data.strategies.forEach(strategyItem => {
                                const li = document.createElement('li');
                                li.style.marginBottom = '15px';
                                li.style.border = '1px solid #eee';
                                li.style.padding = '10px';
                                li.style.borderRadius = '4px';

                                const strategyTitle = document.createElement('h5');
                                strategyTitle.textContent = `${strategyItem.strategy || 'æˆ¦ç•¥'}`;
                                strategyTitle.style.marginTop = '0';
                                strategyTitle.style.marginBottom = '5px';
                                strategyTitle.style.fontSize = '1.1em';
                                
                                const exampleText = document.createElement('p');
                                exampleText.textContent = strategyItem.example || 'å¿œç­”ä¾‹ãªã—';
                                exampleText.style.whiteSpace = 'pre-wrap'; // æ”¹è¡Œã‚’ä¿æŒ
                                exampleText.style.margin = '0';
                                exampleText.style.fontSize = '0.95em';
                                exampleText.style.backgroundColor = '#f9f9f9';
                                exampleText.style.padding = '8px';
                                exampleText.style.borderRadius = '3px';


                                li.appendChild(strategyTitle);
                                li.appendChild(exampleText);
                                ul.appendChild(li);
                            });
                            strategyArea.appendChild(ul);
                        } else {
                            strategyArea.innerHTML = '<p>AIã‹ã‚‰ææ¡ˆã•ã‚ŒãŸæˆ¦ç•¥ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>';
                        }
                    } else {
                        strategyArea.innerHTML = `<p>ã‚¨ãƒ©ãƒ¼: ${result.error || 'æˆ¦ç•¥ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚'}</p>`;
                    }
                })
                .catch(error => {
                    console.error('Error fetching strategy:', error);
                    strategyArea.innerHTML = `<p>æˆ¦ç•¥ã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}</p>`;
                })
                .finally(() => {
                    generateStrategyBtn.disabled = false;
                });
        });
    }


    // ãƒãƒ£ãƒƒãƒˆãƒ­ã‚°ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° (å°‘ã—å¤‰æ›´)
    function addMessageToLog(speaker, message, timestamp, isStreaming = false, targetElement = null) {
        const noDialogueMessage = document.getElementById('no-dialogue-message');
        if (noDialogueMessage) {
            noDialogueMessage.style.display = 'none';
        }

        if (isStreaming && targetElement) { // ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ä¸­ã®è¿½è¨˜
            targetElement.textContent += message;
            targetElement.style.overflowWrap = 'break-word';
            targetElement.style.wordBreak = 'break-word';
        } else { // é€šå¸¸ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¿½åŠ 
            const p = document.createElement('p');
            p.style.overflowWrap = 'break-word';
            p.style.wordBreak = 'break-word';
            
            const strong = document.createElement('strong');
            strong.textContent = speaker + ': ';
            p.appendChild(strong);

            const messageParts = message.split('\n');
            messageParts.forEach((part, index) => {
                p.appendChild(document.createTextNode(part));
                if (index < messageParts.length - 1) {
                    p.appendChild(document.createElement('br'));
                }
            });

            if (timestamp) {
                const timeSpan = document.createElement('span');
                timeSpan.style.fontSize = '0.8em';
                timeSpan.style.color = '#777';
                timeSpan.textContent = ` (${timestamp})`;
                p.appendChild(timeSpan);
            }
            chatLog.appendChild(p);
            return p;
        }
        scrollToBottom();
    }

    if (messageInput && chatForm && submitChatButton) {
            messageInput.addEventListener('keydown', function(event) {
                // Ctrl+Enterã§é€ä¿¡
                if (event.key === 'Enter' && event.ctrlKey) {
                    event.preventDefault();
                    submitChatButton.click();
                }
            });
    }


    if (chatForm) {
        chatForm.addEventListener('submit', function(event) {
            event.preventDefault();
            const userMessage = messageInput.value.trim();
            if (!userMessage) return;

            const userMsgTimestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            const userMessageElement = addMessageToLog('ã‚ãªãŸ (ã‚«ã‚¦ãƒ³ã‚»ãƒ©ãƒ¼)', userMessage, userMsgTimestamp);
            messageInput.value = '';
            messageInput.focus();

            const aiMessagePlaceholder = addMessageToLog('ç›¸è«‡è€… (AI)', '', 'Loading...', false, null);
            let aiFullResponse = "";

            const fetchUrl = sessionId ? 
                `/dialogues/session/${sessionId}/chat/` :
                (isIllegalJob ? `/dialogues/illegal_topic/${topicId}/chat/` : `/dialogues/topic/${topicId}/chat/`);

            fetch(fetchUrl, {
                method: 'POST',
                body: new URLSearchParams({message: userMessage}),
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': csrfToken
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }
                
                // ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã‚’ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ˜ãƒƒãƒ€ãƒ¼ã‹ã‚‰å–å¾—ã—ã¦æ›´æ–°
                const newSessionId = response.headers.get('X-Session-Id');
                if (newSessionId && !sessionId) {
                    sessionId = newSessionId;
                    console.log('Session ID updated:', sessionId);
                    
                    // ãƒ•ã‚©ãƒ¼ãƒ ã®actionå±æ€§ã‚’æ›´æ–°
                    chatForm.action = `/dialogues/session/${sessionId}/chat/`;
                    
                    // æ–°è¦ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®å ´åˆã€è©•ä¾¡ãƒ»ãƒªã‚»ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã‚’å‹•çš„ã«ç”Ÿæˆ
                    if (isNewSession) {
                        const buttonContainer = document.getElementById('button-container');
                        if (buttonContainer) {
                            // æ—¢å­˜ã®ãƒœã‚¿ãƒ³ã‚’å–å¾—
                            const endBtn = document.getElementById('end-dialogue-button');
                            const resetBtn = document.getElementById('reset-dialogue-button');
                            
                            // è©•ä¾¡ãƒ•ã‚©ãƒ¼ãƒ ã‚’ä½œæˆ
                            const endForm = document.createElement('form');
                            endForm.id = 'end-dialogue-form';
                            endForm.method = 'post';
                            endForm.action = `/dialogues/session/${sessionId}/end/`;
                            endForm.style.margin = '0';
                            const endCsrfInput = document.createElement('input');
                            endCsrfInput.type = 'hidden';
                            endCsrfInput.name = 'csrfmiddlewaretoken';
                            endCsrfInput.value = csrfToken;
                            endForm.appendChild(endCsrfInput);
                            endForm.appendChild(endBtn);
                            
                            // ãƒªã‚»ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã‚’ä½œæˆ
                            const resetForm = document.createElement('form');
                            resetForm.id = 'reset-dialogue-form';
                            resetForm.method = 'post';
                            resetForm.action = `/dialogues/session/${sessionId}/reset/`;
                            resetForm.style.margin = '0';
                            const resetCsrfInput = document.createElement('input');
                            resetCsrfInput.type = 'hidden';
                            resetCsrfInput.name = 'csrfmiddlewaretoken';
                            resetCsrfInput.value = csrfToken;
                            resetForm.appendChild(resetCsrfInput);
                            resetForm.appendChild(resetBtn);
                            
                            // buttonContainerã‚’ãƒ•ã‚©ãƒ¼ãƒ ã§ç½®ãæ›ãˆ
                            const parentDiv = buttonContainer.parentElement;
                            buttonContainer.remove();
                            parentDiv.appendChild(endForm);
                            parentDiv.appendChild(resetForm);
                            
                            // ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
                            endBtn.disabled = false;
                            endBtn.type = 'submit';
                            endBtn.style.backgroundColor = '';
                            endBtn.style.color = '';
                            endBtn.style.cursor = '';
                            endBtn.setAttribute('onclick', "return confirm('å¯¾è©±ã‚’çµ‚äº†ã—ã¾ã™ã‹ï¼Ÿ');");
                            
                            resetBtn.disabled = false;
                            resetBtn.type = 'submit';
                            resetBtn.style.backgroundColor = '';
                            resetBtn.style.color = '';
                            resetBtn.style.cursor = '';
                            resetBtn.setAttribute('onclick', "return confirm('æœ¬å½“ã«å¯¾è©±å±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ');");
                            
                            // è©•ä¾¡ãƒ•ã‚©ãƒ¼ãƒ ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å†è¨­å®š
                            setupEndDialogueFormListener();
                        }
                    }
                } else if (sessionId) {
                    // æ—¢å­˜ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®å ´åˆã€ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–ï¼ˆãƒ•ã‚©ãƒ¼ãƒ ã¯æ—¢ã«å­˜åœ¨ï¼‰
                    const endDialogueBtn = document.getElementById('end-dialogue-button');
                    const resetDialogueBtn = document.getElementById('reset-dialogue-button');
                    const endDialogueForm = document.getElementById('end-dialogue-form');
                    const resetDialogueForm = document.getElementById('reset-dialogue-form');
                    
                    if (endDialogueBtn && endDialogueBtn.disabled && endDialogueForm) {
                        endDialogueBtn.disabled = false;
                        endDialogueBtn.style.backgroundColor = '';
                        endDialogueBtn.style.color = '';
                        endDialogueBtn.style.cursor = '';
                        endDialogueBtn.setAttribute('onclick', "return confirm('å¯¾è©±ã‚’çµ‚äº†ã—ã¾ã™ã‹ï¼Ÿ');");
                    }
                    if (resetDialogueBtn && resetDialogueBtn.disabled && resetDialogueForm) {
                        resetDialogueBtn.disabled = false;
                        resetDialogueBtn.style.backgroundColor = '';
                        resetDialogueBtn.style.color = '';
                        resetDialogueBtn.style.cursor = '';
                        resetDialogueBtn.setAttribute('onclick', "return confirm('æœ¬å½“ã«å¯¾è©±å±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ');");
                    }
                }
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                function readChunk() {
                    reader.read().then(({ done, value }) => {
                        if (done) {
                            if (aiMessagePlaceholder) {
                                const timeSpan = aiMessagePlaceholder.querySelector('span');
                                if (timeSpan) timeSpan.textContent = ` (${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' })})`;
                            }
                            return;
                        }
                        const chunkText = decoder.decode(value);
                        const lines = chunkText.split('\n');
                        lines.forEach(line => {
                            if (line.startsWith('data: ')) {
                                try {
                                    const jsonData = JSON.parse(line.substring(5));
                                    if (jsonData.evaluation) {
                                        // âœ… è©•ä¾¡çµæœã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ç›´å¾Œã«è¡¨ç¤º
                                        addEvaluationToLog(jsonData.evaluation.score, jsonData.evaluation.reason, userMessageElement);
                                    } else if (jsonData.text_chunk) {
                                        aiFullResponse += jsonData.text_chunk;
                                        if (aiMessagePlaceholder) {
                                            let messageNode = aiMessagePlaceholder.childNodes[1];
                                            if (!messageNode || messageNode.nodeType !== Node.TEXT_NODE) {
                                                messageNode = document.createTextNode("");
                                                aiMessagePlaceholder.insertBefore(messageNode, aiMessagePlaceholder.querySelector('span'));
                                            }
                                            messageNode.textContent += jsonData.text_chunk;
                                            scrollToBottom();
                                        }
                                    } else if (jsonData.error) {
                                        console.error('Stream error from server:', jsonData.error);
                                        if (aiMessagePlaceholder) aiMessagePlaceholder.textContent += `\nã‚¨ãƒ©ãƒ¼: ${jsonData.error}`;
                                    }
                                } catch (e) {
                                    // JSON parse error
                                }
                            }
                        });
                        readChunk();
                    });
                }
                readChunk();
            })
            .catch(error => {
                console.error('Fetch streaming error:', error);
                if (aiMessagePlaceholder) {
                     aiMessagePlaceholder.textContent += `\né€šä¿¡ã‚¨ãƒ©ãƒ¼: ${error.message}`;
                }
            });
        });
    }

    // è©•ä¾¡ãƒ•ã‚©ãƒ¼ãƒ ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®šã‚’é–¢æ•°åŒ–
    function setupEndDialogueFormListener() {
        const endDialogueFormElement = document.getElementById('end-dialogue-form');
        const loadingOverlay = document.getElementById('loading-overlay');

        if (endDialogueFormElement && !endDialogueFormElement.dataset.listenerAttached) {
            endDialogueFormElement.dataset.listenerAttached = 'true'; // é‡è¤‡ç™»éŒ²é˜²æ­¢
            endDialogueFormElement.addEventListener('submit', function(event) {
                event.preventDefault();
                
                if (!sessionId && !endDialogueFormElement.action.includes('/session/')) {
                    alert('ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒé–‹å§‹ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã¾ãšãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ã¦ãã ã•ã„ã€‚');
                    return;
                }
                
                if (messageInput) messageInput.disabled = true;
                if (submitChatButton) submitChatButton.disabled = true;
                if (generateStrategyBtn) generateStrategyBtn.disabled = true;

                if (loadingOverlay) {
                    loadingOverlay.style.display = 'flex';
                }

                fetch(endDialogueFormElement.action, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (loadingOverlay) {
                        loadingOverlay.style.display = 'none';
                    }

                    if (data.success) {
                        if (data.message) {
                            alert(data.message);
                        }
                        window.location.href = data.redirect_url;
                    } else {
                        alert(data.message || data.error || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
                        if (messageInput) messageInput.disabled = false;
                        if (submitChatButton) submitChatButton.disabled = false;
                        if (generateStrategyBtn) generateStrategyBtn.disabled = false;
                    }
                })
                .catch(error => {
                    if (loadingOverlay) {
                        loadingOverlay.style.display = 'none';
                    }
                    console.error('è©•ä¾¡ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                    alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
                    if (messageInput) messageInput.disabled = false;
                    if (submitChatButton) submitChatButton.disabled = false;
                    if (generateStrategyBtn) generateStrategyBtn.disabled = false;
                });
            });
        }
    }

    // åˆæœŸãƒ­ãƒ¼ãƒ‰æ™‚ã«æ—¢å­˜ãƒ•ã‚©ãƒ¼ãƒ ãŒã‚ã‚Œã°ãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
    setupEndDialogueFormListener();

</script>
{% endblock %}

