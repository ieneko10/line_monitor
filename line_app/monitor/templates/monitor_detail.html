{% extends "base.html" %}

{% block title %}対話ログ - {{ block.super }}{% endblock %}

{% block content %}
<style>
    .log-container {
        width: 100%;
        margin: 0;
    }
    .log-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        flex-wrap: wrap;
        margin-bottom: 12px;
    }
    .log-meta {
        color: #666;
        font-size: 0.95em;
    }
    .chat-log {
        border: 1px solid #ddd;
        border-radius: 10px;
        padding: 12px;
        max-height: 70vh;
        overflow-y: auto;
        background: #fafafa;
    }
    .message {
        margin-bottom: 10px;
        display: flex;
        align-items: flex-start;
    }
    .message.user {
        justify-content: flex-start;
    }
    .message.assistant {
        justify-content: flex-end;
    }
    .message-content {
        display: block;
        padding: 8px 10px;
        border-radius: 15px;
        line-height: 1.3;
        white-space: pre-wrap;
        overflow-wrap: break-word;
        word-break: break-word;
    }
    .message-text {
        margin: 0;
        padding: 0;
    }
    .message > div {
        max-width: 90%;
    }
    .message.user .message-content {
        background-color: #e8f5e9;
        color: #333;
        border: 1px solid #c8e6c9;
        border-top-left-radius: 4px;
    }
    .message.assistant .message-content {
        background-color: #e3f2fd;
        color: #333;
        border: 1px solid #bbdefb;
        border-top-right-radius: 4px;
    }
    .message-meta {
        margin-bottom: 2px;
        font-size: 0.8em;
        color: #777;
        display: flex;
        gap: 8px;
        align-items: center;
    }
    .message-speaker {
        font-weight: bold;
    }
    .message.assistant .message-meta {
        justify-content: flex-end;
    }
    @media (max-width: 768px) {
        .message > div { max-width: 95%; }
    }
</style>

<div class="log-container">
    <h2>対話ログ</h2>
    <div class="log-header">
        <div class="log-meta">ユーザーID: {{ user_id }}</div>
        <button id="stopButton" style="padding: 8px 16px; background-color: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">停止</button>
    </div>

    {% if logs %}
        <div class="chat-log">
            {% for log in logs %}
                <div class="message {% if log.speaker == 'user' %}user{% else %}assistant{% endif %}">
                    <div>
                        <div class="message-meta">
                            <span class="message-speaker">
                                {% if log.speaker == 'user' %}ユーザー{% else %}AI{% endif %}
                            </span>
                            <span>{{ log.post_time|date:"Y/m/d H:i:s" }}</span>
                        </div>
                        <div class="message-content">{{ log.message }}</div>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <p>ログがありません。</p>
    {% endif %}
</div>

<script>
    // 停止ボタンのイベントハンドラ
    const stopButton = document.getElementById('stopButton');
    if (stopButton) {
        stopButton.addEventListener('click', function() {
            if (confirm('セッションを停止しますか？')) {
                const userId = '{{ user_id }}';
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || getCookie('csrftoken');
                fetch(`/monitor/session/stop/${userId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken
                    }
                })
                .then(() => window.location.reload())
                .catch(error => console.error('Stop error:', error));
            }
        });
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // 更新ロジック:
    //  1. 更新前のスクロール位置とメッセージ数を保存
    //  2. 新しいメッセージが追加されたか、または元々一番下にあったかをチェック
    //  3. いずれかの場合は一番下にスクロール
    //  4. そうでない場合は、元のスクロール位置に復元
    setInterval(function() {
        const chatLog = document.querySelector('.chat-log');
        const scrollTop = chatLog ? chatLog.scrollTop : 0;
        const scrollHeight = chatLog ? chatLog.scrollHeight : 0;
        const isAtBottom = chatLog ? (scrollTop + chatLog.clientHeight >= scrollHeight - 10) : false;
        const messageCount = document.querySelectorAll('.message').length;
        
        fetch(window.location.href)
            .then(response => response.text())
            .then(html => {
                const parser = new DOMParser();
                const newDoc = parser.parseFromString(html, 'text/html');
                const newContent = newDoc.querySelector('.log-container');
                const oldContent = document.querySelector('.log-container');
                if (newContent && oldContent) {
                    oldContent.replaceWith(newContent);
                    
                    const newChatLog = document.querySelector('.chat-log');
                    const newMessageCount = document.querySelectorAll('.message').length;
                    
                    if (newChatLog) {
                        if (newMessageCount > messageCount || isAtBottom) {
                            // 新しいメッセージが追加されたか、元々一番下にいた場合は一番下にスクロール
                            setTimeout(() => {
                                newChatLog.scrollTop = newChatLog.scrollHeight;
                            }, 0);
                        } else {
                            // メッセージ数が変わらない場合はスクロール位置を復元
                            newChatLog.scrollTop = scrollTop;
                        }
                    }
                }
            })
            .catch(error => console.error('Update error:', error));
    }, 5000);
</script>
{% endblock %}
